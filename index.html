<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒŸ ì•„ë¦„ë‹¤ìš´ ì‹¤ì‹œê°„ ë°©ëª…ë¡ ğŸŒŸ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-color: #1a1a2e; /* Dark background */
      --card-bg-color: #22223b; /* Slightly lighter card background */
      --text-color: #e0e0e0; /* Light text */
      --accent-color: #e94560; /* Accent for buttons/highlights */
      --border-color: #4a4e69; /* Subtle border */
      --input-bg-color: #3e3e5c; /* Darker input background */
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; /* Center content vertically */
      min-height: 100vh; /* Full viewport height */
      margin: 0;
      padding: 20px;
      box-sizing: border-box; /* Include padding in element's total width and height */
    }

    h1 {
      font-size: 2.8rem;
      margin-bottom: 30px;
      color: var(--accent-color);
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .container {
      background: var(--card-bg-color);
      width: 100%;
      max-width: 700px;
      border-radius: 15px;
      padding: 35px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      margin-bottom: 25px;
    }

    #guestbook-list {
      min-height: 250px;
      max-height: 500px; /* Limit height for scrollability */
      overflow-y: auto;
      margin-bottom: 25px;
      padding-right: 10px; /* For scrollbar spacing */
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .entry {
      background: var(--input-bg-color);
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease-in-out;
    }

    .entry:hover {
      transform: translateY(-3px);
    }

    .entry strong {
      color: var(--accent-color);
      font-size: 1.1em;
      display: block;
      margin-bottom: 5px;
    }

    .entry span.timestamp {
        font-size: 0.8em;
        color: #999;
        margin-top: 5px;
        display: block;
    }

    #guestbook-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    input, textarea {
      padding: 14px 18px;
      font-size: 1.1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--input-bg-color);
      color: var(--text-color);
      outline: none;
      transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    input::placeholder, textarea::placeholder {
      color: #999;
    }

    input:focus, textarea:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.3);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    button {
      padding: 15px 25px;
      font-size: 1.2rem;
      border-radius: 8px;
      border: none;
      background: var(--accent-color);
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease-in-out, transform 0.2s ease-in-out;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    button:hover {
      background: #c7374f; /* Darker accent color on hover */
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    /* Custom Scrollbar for better aesthetics */
    #guestbook-list::-webkit-scrollbar {
        width: 8px;
    }
    #guestbook-list::-webkit-scrollbar-track {
        background: var(--card-bg-color);
        border-radius: 10px;
    }
    #guestbook-list::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 10px;
    }
    #guestbook-list::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
  </style>
</head>
<body>
  <h1>ğŸŒŸ ì•„ë¦„ë‹¤ìš´ ì‹¤ì‹œê°„ ë°©ëª…ë¡ ğŸŒŸ</h1>

  <div class="container">
    <div id="guestbook-list"></div>

    <form id="guestbook-form">
      <input id="username" placeholder="ğŸŒŸ ë‹¹ì‹ ì˜ ì´ë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”?" required />
      <textarea id="message-input" placeholder="âœ¨ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚¨ê¸°ì‹¤ ê±´ê°€ìš”?" required></textarea>
      <button type="submit" id="add-entry-btn">ğŸŒˆ ê¸€ ë‚¨ê¸°ê¸°</button>
    </form>
  </div>

  <script>
    // --- Supabase ì„¤ì • (ğŸš¨ ì´ ë¶€ë¶„ì„ mammi1211ë‹˜ì˜ ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½í•´ ì£¼ì„¸ìš”! ğŸš¨) ---
    const SUPABASE_URL = "https://gfavzpkyevibhnqgdfbf.supabase.co"; // mammi1211ë‹˜ì˜ URL
    const SUPABASE_KEY = "sb_publishable_6ocCrY4Ksi5jGs4FmJgD8A_3lBpvMn9"; // mammi1211ë‹˜ì˜ PUBLIC ANON KEY
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const guestbookListEl = document.getElementById("guestbook-list");
    const guestbookForm = document.getElementById("guestbook-form");
    const usernameInput = document.getElementById("username");
    const messageInput = document.getElementById("message-input");
    const addEntryBtn = document.getElementById("add-entry-btn");

    // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ---
    window.addEventListener("DOMContentLoaded", () => {
      loadGuestbook(); // ê¸°ì¡´ ë°©ëª…ë¡ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
      listenGuestbook(); // ì‹¤ì‹œê°„ ë³€ê²½ ì‚¬í•­ ë“£ê¸°
      guestbookForm.addEventListener("submit", addEntry); // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    });

    // --- ë°©ëª…ë¡ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ---
    async function loadGuestbook() {
      const { data, error } = await supabase
        .from("guestbook") // ğŸš¨ í…Œì´ë¸” ì´ë¦„ì´ "guestbook"ì´ ë§ëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”! ğŸš¨
        .select("*")
        .order("created_at", { ascending: true }); // ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ ì •ë ¬

      if (error) {
        console.error("ğŸš« ë°©ëª…ë¡ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        alert("ë°©ëª…ë¡ ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        return;
      }

      guestbookListEl.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°
      data.forEach(addEntryToDOM); // ê° ê¸€ì„ DOMì— ì¶”ê°€
      scrollToBottom(); // ìŠ¤í¬ë¡¤ì„ ê°€ì¥ ì•„ë˜ë¡œ
    }

    // --- ìƒˆë¡œìš´ ë°©ëª…ë¡ ê¸€ ì¶”ê°€ ---
    async function addEntry(event) {
      event.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë™ì‘ ë°©ì§€ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë§‰ê¸°)

      const username = usernameInput.value.trim();
      const message = messageInput.value.trim();

      if (!username) {
        alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! ğŸ˜¥");
        usernameInput.focus();
        return;
      }
      if (!message) {
        alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! ğŸ˜…");
        messageInput.focus();
        return;
      }

      // ê¸€ ì‘ì„± ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë©”ì‹œì§€ ë³€ê²½
      addEntryBtn.disabled = true;
      addEntryBtn.textContent = "ì‘ì„± ì¤‘...";

      const { error } = await supabase
        .from("guestbook") // ğŸš¨ í…Œì´ë¸” ì´ë¦„ì´ "guestbook"ì´ ë§ëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”! ğŸš¨
        .insert([
          { username: username, message: message }
        ]);

      if (error) {
        console.error("ğŸš« ê¸€ ì‘ì„± ì‹¤íŒ¨:", error);
        alert("ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
      } else {
        // ì„±ê³µ ì‹œ ì…ë ¥ì°½ ì´ˆê¸°í™”
        usernameInput.value = "";
        messageInput.value = "";
        // ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ ë³´ì—¬ì£¼ê¸°
        // alert("ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨"); // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¡œ ê¸€ì´ ë°”ë¡œ ë³´ì´ë¯€ë¡œ ë¶ˆí•„ìš”
      }

      // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™” ë° í…ìŠ¤íŠ¸ ì›ìƒ ë³µêµ¬
      addEntryBtn.disabled = false;
      addEntryBtn.textContent = "ğŸŒˆ ê¸€ ë‚¨ê¸°ê¸°";
    }

    // --- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°ì§€ ë° ë°˜ì˜ ---
    function listenGuestbook() {
      supabase
        .channel("public:guestbook") // ğŸš¨ ì±„ë„ ì´ë¦„ì„ í…Œì´ë¸” ì´ë¦„ìœ¼ë¡œ í†µì¼í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤. ğŸš¨
        .on(
          "postgres_changes",
          { event: "INSERT", schema: "public", table: "guestbook" }, // ğŸš¨ í…Œì´ë¸” ì´ë¦„ì´ "guestbook"ì´ ë§ëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”! ğŸš¨
          (payload) => {
            console.log("ğŸŒŸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°ì§€ (ìƒˆ ê¸€):", payload);
            addEntryToDOM(payload.new); // ìƒˆë¡œ ì¶”ê°€ëœ ê¸€ DOMì— ë°˜ì˜
            scrollToBottom();
          }
        )
        .subscribe();
    }

    // --- DOMì— ë°©ëª…ë¡ ê¸€ ì¶”ê°€ (HTML ìš”ì†Œ ìƒì„±) ---
    function addEntryToDOM(entry) {
      const div = document.createElement("div");
      div.classList.add("entry");

      // ë‚ ì§œ í¬ë§·íŒ… (ë” ì½ê¸° ì‰½ê²Œ)
      const date = new Date(entry.created_at);
      const formattedDate = date.toLocaleString('ko-KR', {
          year: 'numeric',
          month: 'numeric',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false // 24ì‹œê°„ í˜•ì‹
      });

      div.innerHTML = `
        <strong>${entry.username}</strong>
        <p>${entry.message.replace(/\n/g, '<br>')}</p>
        <span class="timestamp">${formattedDate}</span>
      `;
      guestbookListEl.appendChild(div);
    }

    // --- ìŠ¤í¬ë¡¤ì„ í•­ìƒ ê°€ì¥ ì•„ë˜ë¡œ ---
    function scrollToBottom() {
      guestbookListEl.scrollTop = guestbookListEl.scrollHeight;
    }
  </script>
</body>
</html>